"use strict";(self.webpackChunkatomic_swap_frontend=self.webpackChunkatomic_swap_frontend||[]).push([[694],{49694:function(e,t,n){n.a(e,(async function(e,r){try{n.r(t),n.d(t,{WebhookBch:function(){return b}});var s=n(93433),a=n(37762),i=n(74165),c=n(15861),u=n(15671),o=n(43144),h=n(97326),p=n(60136),f=n(29388),k=n(9092),x=n(80245),v=n(43430),d=n(74902),l=e([x,k]);[x,k]=l.then?(await l)():l;var b=function(e){(0,p.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).seenStatuses=[],Object.assign((0,h.Z)(r),e),r}return(0,o.Z)(n,[{key:"stop",value:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wallet.provider.unsubscribeFromAddress(this.cashaddr,this.callback);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(){var t,n=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=function(){var e=(0,c.Z)((0,i.Z)().mark((function e(t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="","string"!==typeof t){e.next=7;break}if(r=t,""!==n.status){e.next=5;break}return e.abrupt("return");case 5:case 11:e.next=14;break;case 7:if(!(t instanceof Array)){e.next=13;break}if(r=t[1],t[0]===n.cashaddr){e.next=11;break}return e.abrupt("return");case 13:return e.abrupt("return");case 14:if(r==n.status||-1!==n.seenStatuses.indexOf(r)){e.next=18;break}return n.seenStatuses.push(r),e.next=18,n.handler(r);case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.callback=t,e.next=4,x.w5.fromCashaddr(this.cashaddr);case 4:return this.wallet=e.sent,e.next=7,this.wallet.provider.subscribeToAddress(this.cashaddr,this.callback);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"handler",value:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(t){var n,r,c,u,o,h,p,f,x,l,b,Z,w,y,g,m,_,H,W,O=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wallet.provider.getHistory(this.cashaddr);case 2:n=e.sent,r=[],""===t?r=n.slice(-1):(c=n.reverse(),this.tx_seen=this.tx_seen.map((function(e){if(e.height<=0){var t=c.find((function(t){return t.tx_hash===e.tx_hash}));t&&(e.height=t.height)}return e})),u=this.tx_seen.map((function(e){return e.tx_hash})),r=n.filter((function(e){return(e.height>=O.last_height||e.height<=0)&&!u.includes(e.tx_hash)}))),o=!0,h=(0,a.Z)(r),e.prev=7,h.s();case 9:if((p=h.n()).done){e.next=58;break}if(f=p.value,x=!1,!(this.type.indexOf("transaction:")>=0)){e.next=39;break}return e.next=15,this.wallet.provider.getRawTransactionObject(f.tx_hash);case 15:return l=e.sent,e.next=18,Promise.all(l.vin.map((function(e){return O.wallet.provider.getRawTransactionObject(e.txid)})));case 18:if(b=e.sent,Z=l.vout.some((function(e){return e.scriptPubKey.addresses.includes(O.cashaddr)})),w=b.some((function(e){return e.vout.some((function(e){return e.scriptPubKey.addresses.includes(O.cashaddr)}))})),y=this.type.indexOf("in")>=0,g=this.type.indexOf("out")>=0,m=w&&Z?v.Ez.transactionInOut:w?v.Ez.transactionOut:v.Ez.transactionIn,!y||!Z){e.next=30;break}return e.next=27,this.post({direction:m,data:l});case 27:x=e.sent,e.next=37;break;case 30:if(!g||!w){e.next=36;break}return e.next=33,this.post({direction:m,data:l});case 33:x=e.sent,e.next=37;break;case 36:return e.abrupt("continue",56);case 37:e.next=49;break;case 39:if(this.type!==v.Ez.balance){e.next=49;break}return e.next=42,this.wallet.provider.getBalance(this.cashaddr);case 42:return _=e.sent,e.next=45,(0,k.Wk)(_);case 45:return H=e.sent,e.next=48,this.post(H);case 48:x=e.sent;case 49:if(!x){e.next=55;break}return this.tx_seen.push(f),e.next=53,this.db.setWebhookSeenTxLastHeight(this.id,this.tx_seen,this.last_height);case 53:e.next=56;break;case 55:o=!1;case 56:e.next=9;break;case 58:e.next=63;break;case 60:e.prev=60,e.t0=e.catch(7),h.e(e.t0);case 63:return e.prev=63,h.f(),e.finish(63);case 66:if(!o){e.next=84;break}if(this.recurrence!==v.CM.once){e.next=75;break}return e.next=70,d.Z.instance();case 70:return e.next=72,e.sent.stopHook(this);case 72:return e.next=74,this.destroy();case 74:return e.abrupt("return");case 75:return this.status=t,e.next=78,this.db.setWebhookStatus(this.id,t);case 78:if(!((W=Math.max.apply(Math,(0,s.Z)(this.tx_seen.map((function(e){return e.height})))))>=this.last_height)){e.next=84;break}return this.last_height=W,this.tx_seen=this.tx_seen.filter((function(e){return e.height===W||e.height<=0})),e.next=84,this.db.setWebhookSeenTxLastHeight(this.id,this.tx_seen,this.last_height);case 84:case"end":return e.stop()}}),e,this,[[7,60,63,66]])})));return function(t){return e.apply(this,arguments)}}()}]),n}(v.G2);r()}catch(Z){r(Z)}}))},74902:function(e,t,n){n.d(t,{Z:function(){return h}});var r=n(29439),s=n(37762),a=n(74165),i=n(15861),c=n(15671),u=n(43144),o=n(61130),h=function(){function e(){(0,c.Z)(this,e),this.activeHooks=new Map,this.callbacks=new Map,this.checkInterval=void 0,this.db=new o.Z}return(0,u.Z)(e,[{key:"init",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){var t=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db.init();case 2:return e.next=4,this.evictOldHooks();case 4:return e.next=6,this.pickupHooks(!0);case 6:this.checkInterval||(this.checkInterval=setInterval((0,i.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.evictOldHooks();case 2:return e.next=4,t.pickupHooks(!0);case 4:case"end":return e.stop()}}),e)}))),3e5));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.stopAll();case 2:this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=void 0);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"pickupHooks",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){var t,n,r,i,c,u=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]&&u[0],e.next=3,this.db.getWebhooks();case 3:n=e.sent,r=(0,s.Z)(n),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=16;break}if(c=i.value,this.activeHooks.has(c.id)){e.next=14;break}if(this.activeHooks.set(c.id,c),!t){e.next=14;break}return e.next=14,c.start();case 14:e.next=7;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(5),r.e(e.t0);case 21:return e.prev=21,r.f(),e.finish(21);case 24:case"end":return e.stop()}}),e,this,[[5,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"evictOldHooks",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){var t,n,r,i,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Date,e.next=3,this.db.getWebhooks();case 3:n=e.sent,r=(0,s.Z)(n),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=17;break}if(c=i.value,!(t>=c.expires_at)){e.next=15;break}if(!this.activeHooks.has(c.id)){e.next=13;break}return e.next=13,this.stopHook(c);case 13:return e.next=15,this.db.deleteWebhook(c.id);case 15:e.next=7;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(5),r.e(e.t0);case 22:return e.prev=22,r.f(),e.finish(22);case 25:case"end":return e.stop()}}),e,this,[[5,19,22,25]])})));return function(){return e.apply(this,arguments)}}()},{key:"registerWebhook",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var n,r,s=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(s.length>1&&void 0!==s[1])||s[1],e.next=3,this.db.addWebhook(t);case 3:if(r=e.sent,!n){e.next=8;break}return this.activeHooks.set(r.id,r),e.next=8,r.start();case 8:return e.abrupt("return",r.id);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getWebhook",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.activeHooks.has(t)){e.next=2;break}return e.abrupt("return",this.activeHooks.get(t));case 2:return e.next=4,this.db.getWebhook(t);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"deleteWebhook",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.activeHooks.has(t)){e.next=3;break}return e.next=3,this.stopHook(this.activeHooks.get(t));case 3:return e.next=5,this.db.deleteWebhook(t);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"deleteAllWebhooks",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.stopAll();case 2:return e.next=4,this.db.clearWebhooks();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stopAll",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){var t,n,i,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=(0,s.Z)(this.activeHooks),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return i=(0,r.Z)(n.value,2),c=i[1],e.next=7,this.stopHook(c);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])})));return function(){return e.apply(this,arguments)}}()},{key:"stopHook",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.activeHooks.has(t.id)){e.next=4;break}return e.next=3,t.stop();case 3:this.activeHooks.delete(t.id);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}],[{key:"instance",value:function(){var t=(0,i.Z)((0,a.Z)().mark((function t(){return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._instance){t.next=4;break}return e._instance=new e,t.next=4,e._instance.init();case 4:return t.abrupt("return",e._instance);case 5:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}()}]),e}()}}]);